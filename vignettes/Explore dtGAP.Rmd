---
title: "Explore dtGAP"
author: "Han-Ming Wu, Chia-Yu Chang, and Chun-houh Chen"
date: "2025-06-12"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    number_sections: true  

vignette: >
  %\VignetteIndexEntry{Introduction to dtGAP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
	error = FALSE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	comment = "#>",
	include = TRUE,
	out.width = "100%"
)
library(knitr)
library(dplyr)
library(stringr)
library(ComplexHeatmap)
library(dendextend)
library(circlize)
library(reshape2)
library(grid)
library(gridExtra)
library(knitr)
library(pander)
library(ggplot2)
library(ape)
library(ggdendro)
library(RColorBrewer)
library(rpart.plot)
library(caret)
library(party)
library(ggparty)
library(rpart)
library(party)
library(partykit)
library(C50)
library(seriation)
library(treeheatr)
```

You can download the development version from the website:

```{r install_pkg, echo=TRUE}
library(dtGAP)
```

$$\\[0.3in]$$

# Introduction

Decision trees are prized for their simplicity and interpretability but often fail to reveal underlying data structures. Generalized Association Plots (GAP) excel at illustrating complex associations yet are typically unsupervised. We introduce `dtGAP`, a novel framework that embeds **supervised correlation** and distance measures into GAP for enriched **decision-tree visualization**. `dtGAP` offers confusion matrix maps, decision-tree matrix maps, predicted class membership maps, and evaluation panels. The `dtGAP` package is currently available on the Comprehensive R Archive Network (CRAN) at (<https://CRAN.R-project.org/package=dtGAP>) and (<https://hmwu.idv.tw/dtGAP>).

**Current version** (build on June 11, 2025): [dtGAP_0.1.1.zip]() $$\\[0.3in]$$
$$\\[0.3in]$$

# Let's begin

with the penguins dataset!
Running the `heat_tree()` function can be as simple as:

```{r dtGAP_ex1, echo=TRUE, fig.height=9, fig.width=11}

penguins <- na.omit(penguins)
dtGAP(data_all = penguins, model = "party", show = "all", trans_type = "percentize", target_lab = "species", simple_metrics = TRUE, label_map_colors = c("Adelie" = "#50046d", "Gentoo" = "#fcc47f", "Chinstrap" = "#e15b76"), show_col_prox = FALSE, show_row_prox = FALSE, y_eval_start = 220, raw_value_col = colorRampPalette(c("#33286b", "#26828e", "#75d054", "#fae51f"))(9))
```
$$\\[0.3in]$$
# You’re the Warren Beatty of your heat_tree()

### Pre-train your tree

If the default conditional tree is not desired, you can create your tree (e.g. with `rpart`) and wrap `as.party()` around this object to plug into `heat_tree()`.
As an example, we will examine the datasets of COVID-19 cases in Wuhan from 2020-01-10 to 2020-02-18 from a [recent study](https://doi.org/10.1038/s42256-020-0180-7).

```{r dtGAP_ex2, echo=TRUE, fig.height=9, fig.width=11}

dtGAP(data_train = train_covid, data_test = test_covid, target_lab = "Outcome", show = "train", label_map = c("0" = "Survival", "1" = "Death"), label_map_colors = c("Survival" = "#50046d", "Death" = "#fcc47f"), simple_metrics = TRUE, show_col_prox = FALSE, show_row_prox = FALSE, y_eval_start = 200, raw_value_col = colorRampPalette(c("#33286b", "#26828e", "#75d054", "#fae51f"))(9))

```
$$\\[0.3in]$$

# Apply the learned tree on external/holdout/test/validation dataset


You can print measures evaluating the conditional decision tree's performance by setting `print_eval = TRUE`.
By defaults, we show 5 measures for classification tasks:

- Accuracy
- Balanced accuracy (BAL_ACCURACY)
- Kappa coefficient (KAP)
- Area under the receiver operating characteristics curve (ROC_AUC)
- Area under the precision recall curve (PR_AUC)

and 4 measures for regression tasks:

- R-squared (RSQ)
- Mean absolute error (MAE)
- Root mean squared error (RMSE)
- Concordance correlation coefficient (CCC).

```{r dtGAP_ex3, echo=TRUE, fig.height=9, fig.width=11}

dtGAP(data_train = train_covid, data_test = test_covid, target_lab = "Outcome", show = "test", label_map = c("0" = "Survival", "1" = "Death"), label_map_colors = c("Survival" = "#50046d", "Death" = "#fcc47f"), simple_metrics = TRUE, show_col_prox = FALSE, show_row_prox = FALSE, y_eval_start = 200, raw_value_col = colorRampPalette(c("#33286b", "#26828e", "#75d054", "#fae51f"))(9))

```
$$\\[0.3in]$$

# regression

In general, compared to classification, regression task is more difficult to interpret with a decision tree.
However, a heatmap may shed some light on how the tree groups the samples in different terminal nodes.
Also, removing the terminal node label may show the groups better.
Here's an example:

```{r dtGAP_ex4, echo=TRUE, fig.height=9, fig.width=11}
dtGAP(data_all = galaxy, task = "regression", target_lab = "target", show = "all", trans_type = "percentize", model = "party", simple_metrics = TRUE, show_col_prox = FALSE, show_row_prox = FALSE, x_eval_start = 200, y_eval_start = 200, raw_value_col = colorRampPalette(c("#33286b", "#26828e", "#75d054", "#fae51f"))(9))
```
$$\\[0.3in]$$
# Smart node layout

These extreme visualizations may not be very interpretable but serves the purpose of showing the ability to generalize of the node layout when the tree grows in size.
The implemented smart layout weighs the x-position of the parent node according to the level of the child nodes as to avoid crossing of tree branches.
This relative weight can be adjusted with the `lev_fac` parameter in `heat_tree()`.
The default `lev_fac = 1.3` seems to provide aesthetically pleasing trees, independent of the tree size.

In this next figure, on the top, `lev_fac = 1` makes parent node perfectly in the middle of child nodes (note a few branch crossing), which contrasts `lev_fac = 1.3` (default) on the bottom.

While extreme tree visualizations may reduce immediate interpretability, they effectively illustrate the structural adaptability of our layout algorithm in the context of increasing tree complexity. The horizontal positioning of tree components is governed by the tree_p parameter in dtGAP(), which determines the proportion of the overall canvas dedicated to the tree structure. Adjusting tree_p helps mitigate issues such as branch overlapping by providing adequate spacing between nodes.

```{r dtGAP_ex5, echo=TRUE, fig.height=9, fig.width=12}
dtGAP(data_all = wine_quality_red, target_lab = "target", show = "all", model = "party", simple_metrics = TRUE, show_col_prox = FALSE, show_row_prox = FALSE, y_eval_start = 40, raw_value_col = colorRampPalette(c("#33286b", "#26828e", "#75d054", "#fae51f"))(9), show_row_names = FALSE)
```

```{r dtGAP_ex9, echo=TRUE, fig.height=9, fig.width=12}
dtGAP(data_all = wine_quality_red, target_lab = "target", show = "all", model = "party", simple_metrics = TRUE, tree_p = 0.4, show_col_prox = FALSE, show_row_prox = FALSE, y_eval_start = 40, raw_value_col = colorRampPalette(c("#33286b", "#26828e", "#75d054", "#fae51f"))(9), show_row_names = FALSE)
```

$$\\[0.3in]$$

# Citation

Han-Ming Wu, Chia-Yu Chang, and Chun-houh Chen (2025), dtGAP: Supervised matrix visualization for decision trees based on the GAP framework. R package version 0.1.0, (<https://CRAN.R-project.org/package=dtGAP>).

$$\\[0.1in]$$ **References:**

-   Chen, C. H. (2002). Generalized association plots: Information visualization via iteratively generated correlation matrices. Statistica Sinica, 12, 7–29.
-   Le, T. T., & Moore, J. H. (2021). Treeheatr: An R package for interpretable decision tree visualizations. Bioinformatics, 37(2), 282-284.
-   Wu, H. M., Tien, Y. J., & Chen, C. H. (2010). GAP: A graphical environment for matrix visualization and cluster analysis. Computational Statistics & Data Analysis, 54(3), 767-778.
